<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Household Expense Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow: hidden;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Simple loading spinner */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Ensure charts are responsive */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* Style for color picker */
        .category-color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            background-color: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
        }
        .category-color-picker::-webkit-color-swatch {
            border-radius: 50%;
            border: 1px solid #e2e8f0; /* gray-200 */
        }
        .category-color-picker::-moz-color-swatch {
            border-radius: 50%;
            border: 1px solid #e2e8f0; /* gray-200 */
        }
        .dark .category-color-picker::-webkit-color-swatch {
            border: 1px solid #4b5563; /* gray-600 */
        }
        .dark .category-color-picker::-moz-color-swatch {
            border: 1px solid #4b5563; /* gray-600 */
        }
    </style>
    <script>
        // On page load, apply dark mode immediately to prevent flashing
        try {
            const settingsData = localStorage.getItem('appSettings');
            // Default to dark unless settings exist and explicitly set to false
            if (settingsData && JSON.parse(settingsData).darkMode === false) {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
        } catch (e) {
            console.error('Could not apply dark mode setting from localStorage', e);
            document.documentElement.classList.add('dark'); // Default to dark on error
        }

        // Configure Tailwind to use Inter font
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <!-- Header -->
    <header class="bg-white shadow-md dark:bg-gray-800 dark:border-b dark:border-gray-700">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <a href="#dashboard" class="nav-link">
                <h1 class="text-3xl font-bold text-blue-600">Expense Tracker</h1>
            </a>
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-4">
                <a href="#dashboard" class="nav-link text-gray-700 hover:text-blue-600 font-medium dark:text-gray-300 dark:hover:text-blue-400">Dashboard</a>
                <a href="#expenses" class="nav-link text-gray-700 hover:text-blue-600 font-medium dark:text-gray-300 dark:hover:text-blue-400">Expenses</a>
                <a href="#recurring" class="nav-link text-gray-700 hover:text-blue-600 font-medium dark:text-gray-300 dark:hover:text-blue-400">Recurring</a>
                <a href="#budgets" class="nav-link text-gray-700 hover:text-blue-600 font-medium dark:text-gray-300 dark:hover:text-blue-400">Budgets</a>
                <a href="#data" class="nav-link text-gray-700 hover:text-blue-600 font-medium dark:text-gray-300 dark:hover:text-blue-400">Data</a>
            </nav>
        </div>
        <!-- Mobile Navigation (hidden by default) -->
        <nav id="mobile-menu" class="md:hidden hidden flex-col px-4 pt-2 pb-4 space-y-2 bg-white border-t dark:bg-gray-800 dark:border-gray-700">
            <a href="#dashboard" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-blue-600 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-blue-400">Dashboard</a>
            <a href="#expenses" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-blue-600 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-blue-400">Expenses</a>
            <a href="#recurring" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-blue-600 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-blue-400">Recurring</a>
            <a href="#budgets" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-blue-600 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-blue-400">Budgets</a>
            <a href="#data" class="nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-blue-600 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-blue-400">Data</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">

        <!-- Section: Dashboard -->
        <section id="dashboard" class="app-section space-y-6">
            <h2 class="text-2xl font-semibold mb-4 dark:text-white">Dashboard</h2>
            
            <!-- Filters -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-medium mb-3 dark:text-white">Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                        <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label>
                        <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    </div>
                    <div>
                        <label for="filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="filter-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Categories</option>
                            <!-- JS will populate this -->
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button id="quick-filter-week" class="quick-filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">This Week</button>
                    <button id="quick-filter-month" class="quick-filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">This Month</button>
                    <button id="quick-filter-last-month" class="quick-filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">Last Month</button>
                    <button id="quick-filter-year" class="quick-filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">This Year</button>
                </div>
                <hr class="my-4 dark:border-gray-600">
                <button id="apply-filters-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Apply Filters</Cbutton>
                <button id="reset-filters-btn" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Reset Filters</Cbutton>

            </div>

            <!-- Summaries -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Total Spend (Filtered)</h3>
                    <p id="summary-total" class="text-3xl font-bold mt-2 dark:text-white">$0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">This Month's Spend</h3>
                    <p id="summary-month" class="text-3xl font-bold mt-2 dark:text-white">$0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Remaining Salary</h3>
                    <p id="summary-remaining" class="text-3xl font-bold mt-2 dark:text-white">$0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">This Year's Spend</h3>
                    <p id="summary-year" class="text-3xl font-bold mt-2 dark:text-white">$0.00</p>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white">Category Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white">Spending Over Time</h3>
                    <div class="chart-container">
                        <canvas id="spendingLineChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Expenses -->
        <section id="expenses" class="app-section space-y-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 dark:text-white">Manage Expenses</h2>
            
            <!-- Add/Edit Expense Form -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 id="expense-form-title" class="text-xl font-semibold mb-4 dark:text-white">Add New Expense</h3>
                <form id="expense-form" class="space-y-4">
                    <input type="hidden" id="expense-id">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="expense-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount <span id="currency-label-form" class="text-gray-500 dark:text-gray-400">(MAD)</span></label>
                        <input type="number" id="expense-amount" step="0.01" min="0" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
                    </div>
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="expense-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                            <!-- JS will populate this -->
                        </select>
                    </div>
                    <div>
                        <label for="expense-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Note (Optional)</label>
                        <textarea id="expense-note" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" placeholder="e.g., Dinner with friends"></textarea>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button type="submit" id="expense-submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Add Expense</button>
                        <button type="button" id="expense-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 hidden">Cancel Edit</button>
                    </div>
                </form>
            </div>
            
            <!-- Expense List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="p-6 flex flex-col md:flex-row justify-between md:items-center">
                    <h3 class="text-xl font-semibold dark:text-white mb-4 md:mb-0">Expense List</h3>
                    <div class="relative w-full md:w-1/2 lg:w-1/3">
                        <label for="search-bar" class="sr-only">Search by Note</label>
                        <input type="search" id="search-bar" placeholder="Search by note..." class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Amount</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Note</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- JS will populate this -->
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No expenses found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Section: Recurring Expenses -->
        <section id="recurring" class="app-section space-y-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 dark:text-white">Recurring Expenses</h2>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Add monthly expenses like rent or subscriptions. You can then manually add them to your expenses each month from the list below.</p>
            </div>

            <!-- Add/Edit Recurring Expense Form -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 id="recurring-form-title" class="text-xl font-semibold mb-4 dark:text-white">Add Recurring Expense</h3>
                <form id="recurring-form" class="space-y-4">
                    <input type="hidden" id="recurring-id">
                    <div>
                        <label for="recurring-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount <span id="currency-label-recurring-form" class="text-gray-500 dark:text-gray-400">(MAD)</span></label>
                        <input type="number" id="recurring-amount" step="0.01" min="0" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
                    </div>
                    <div>
                        <label for="recurring-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="recurring-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                            <!-- JS will populate this -->
                        </select>
                    </div>
                    <div>
                        <label for="recurring-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Note</label>
                        <input type="text" id="recurring-note" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" placeholder="e.g., Netflix, Rent" required>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button type="submit" id="recurring-submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Add Recurring</button>
                        <button type="button" id="recurring-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 hidden">Cancel Edit</button>
                    </div>
                </form>
            </div>
            
            <!-- Recurring Expense List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold p-6 dark:text-white">Recurring List</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Amount</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Note</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Last Added</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Add</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recurring-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- JS will populate this -->
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No recurring expenses found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Section: Budgets -->
        <section id="budgets" class="app-section space-y-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 dark:text-white">Monthly Budgets</h2>
            
            <!-- Set Budgets Form -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 dark:text-white">Set Budgets & Salary</h3>
                <form id="budget-form" class="space-y-4">
                    <div>
                        <label for="base-salary" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Base Monthly Salary</label>
                        <input type="number" id="base-salary" step="0.01" min="0" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    </div>
                    
                    <hr class="my-4 dark:border-gray-600">
                    <h4 class="text-lg font-medium text-gray-800 dark:text-white">Monthly Category Budgets</h4>

                    <div id="budget-categories-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- JS will populate this -->
                    </div>
                    <button type="submit" id="budget-submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Save Budgets</button>
                </form>
            </div>

            <!-- Budget Status -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 dark:text-white">This Month's Budget Status</h3>
                <div id="budget-status-list" class="space-y-4">
                    <!-- JS will populate this -->
                    <p class="text-gray-500 dark:text-gray-400">Budgets not set. Go to the "Set Budgets" form to add them.</p>
                </div>
            </div>
        </section>

        <!-- Section: Data Management -->
        <section id="data" class="app-section space-y-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 dark:text-white">Data Management</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Export Data -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white">Export Data</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Download all your expenses as a CSV file.</p>
                    <button id="export-csv-btn" class="px-6 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Export to CSV</button>
                </div>

                <!-- App Settings -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white">App Settings</h3>
                    
                    <!-- Currency Setting -->
                    <form id="currency-form">
                        <label for="currency-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Currency</label>
                        <select id="currency-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="MAD">MAD (Morocco)</option>
                            <option value="USD">USD (United States)</option>
                            <option value="EUR">EUR (Euro)</option>
                            <option value="GBP">GBP (Great Britain)</option>
                            <option value="JPY">JPY (Japan)</option>
                        </select>
                        <button id="save-settings-btn" type="submit" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Save Currency</button>
                    </form>
                    
                    <hr class="my-6 dark:border-gray-600">
                    
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
                        <button id="dark-mode-toggle" type="button" class="bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" role="switch" aria-checked="false">
                            <span class="sr-only">Use dark mode</span>
                            <span id="dark-mode-dot" aria-hidden="true" class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                </div>

                <!-- Import Data -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white">Import Data</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Import expenses from a CSV file. The CSV must have columns: `id`, `date` (YYYY-MM-DD), `amount`, `category`, `note`.</p>
                    <input type="file" id="import-csv-input" accept=".csv" class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900 dark:file:text-blue-300 dark:hover:file:bg-blue-800">
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Import Mode:</p>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="import-mode" value="merge" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                                <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">Merge (add new)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="import-mode" value="replace" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">Replace (delete all)</span>
                            </label>
                        </div>
                    </div>
                    <button id="import-csv-btn" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" disabled>Import CSV</button>
                </div>

            </div> <!-- This div closes the grid -->

                <!-- Manage Categories -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 dark:text-white">Manage Categories</h3>
                <form id="category-form" class="flex items-center space-x-2 mb-4">
                    <div class="w-1/4">
                        <label for="new-category-icon" class="sr-only">Icon</label>
                        <input type="text" id="new-category-icon" placeholder="Icon (e.g., 🍔)" maxlength="2" class="block w-full text-center rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    </div>
                    <div class="flex-grow">
                        <label for="new-category-name" class="sr-only">New category name</label>
                        <input type="text" id="new-category-name" placeholder="New category name" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </form>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Note: Deleting a category will re-assign its expenses to "Other".</p>
                <ul id="category-list" class="space-y-2">
                    <!-- JS will populate this -->
                </ul>
            </div>

             <!-- Danger Zone -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-2 border-red-300 dark:border-red-700">
                <h3 class="text-xl font-semibold mb-4 text-red-700 dark:text-red-500">Danger Zone</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Permanently delete all expenses and budgets. This action cannot be undone.</p>
                <button id="delete-all-data-btn" class="px-6 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Delete All Data</button>
            </div>
        </section>

    </main>
    
    <!-- Footer -->
    <footer class="bg-white mt-12 py-6 border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700">
        <div class="container mx-auto px-4 text-center text-gray-500 dark:text-gray-400">
            <p>&copy; 2025 Household Expense Tracker. All data is stored locally in your browser.</p>
        </div>
    </footer>

    <!-- Custom Modal -->
    <div id="custom-modal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0">
        <!-- Modal Backdrop -->
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        
        <!-- Modal Content -->
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 z-10 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold dark:text-white">Confirmation</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p id="modal-body" class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to perform this action?</p>
            <div id="modal-footer" class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
    </div>


    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & CONSTANTS ---
            let expenses = [];
            let budgets = {};
            let appSettings = {};
            let filters = {
                startDate: '',
                endDate: '',
                category: '',
                searchTerm: ''
            };
            
            // This is now the default, but will be loaded from settings
            let defaultCategories = [
                { name: 'Food', icon: '🍔', color: '#F87171' }, // red-400
                { name: 'Bills', icon: '🧾', color: '#60A5FA' }, // blue-400
                { name: 'Groceries', icon: '🛒', color: '#34D399' }, // green-400
                { name: 'Home Items', icon: '🏠', color: '#FBBF24' }, // amber-400
                { name: 'Other', icon: '❓', color: '#A78BFA' } // violet-400
            ];

            // Chart instances
            let categoryPieChart = null;
            let spendingLineChart = null;

            // --- UI ELEMENTS ---
            const expenseForm = document.getElementById('expense-form');
            const expenseFormTitle = document.getElementById('expense-form-title');
            const expenseSubmitBtn = document.getElementById('expense-submit-btn');
            const expenseCancelBtn = document.getElementById('expense-cancel-btn');
            const expenseIdInput = document.getElementById('expense-id');
            const expenseDateInput = document.getElementById('expense-date');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseCategoryInput = document.getElementById('expense-category');
            const expenseNoteInput = document.getElementById('expense-note');
            const expenseListEl = document.getElementById('expense-list');
            const searchBar = document.getElementById('search-bar');
            
            const budgetForm = document.getElementById('budget-form');
            const baseSalaryInput = document.getElementById('base-salary');
            const budgetCategoriesFormEl = document.getElementById('budget-categories-form');
            const budgetStatusListEl = document.getElementById('budget-status-list');
            
            const filterStartDate = document.getElementById('filter-start-date');
            const filterEndDate = document.getElementById('filter-end-date');
            const filterCategory = document.getElementById('filter-category');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const resetFiltersBtn = document.getElementById('reset-filters-btn');
            const quickFilterWeekBtn = document.getElementById('quick-filter-week');
            const quickFilterMonthBtn = document.getElementById('quick-filter-month');
            const quickFilterLastMonthBtn = document.getElementById('quick-filter-last-month');
            const quickFilterYearBtn = document.getElementById('quick-filter-year');

            const summaryTotalEl = document.getElementById('summary-total');
            const summaryMonthEl = document.getElementById('summary-month');
            const summaryRemainingEl = document.getElementById('summary-remaining');
            const summaryYearEl = document.getElementById('summary-year');

            const exportCsvBtn = document.getElementById('export-csv-btn');
            const importCsvInput = document.getElementById('import-csv-input');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const deleteAllDataBtn = document.getElementById('delete-all-data-btn');
            
            const currencyForm = document.getElementById('currency-form');
            const currencySelect = document.getElementById('currency-select');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const currencyLabelForm = document.getElementById('currency-label-form');
            
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const darkModeDot = document.getElementById('dark-mode-dot');

            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            const loadingSpinner = document.getElementById('loading-spinner');

            const navLinks = document.querySelectorAll('.nav-link');
            const appSections = document.querySelectorAll('.app-section');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            // New Recurring Elements
            const recurringForm = document.getElementById('recurring-form');
            const recurringFormTitle = document.getElementById('recurring-form-title');
            const recurringSubmitBtn = document.getElementById('recurring-submit-btn');
            const recurringCancelBtn = document.getElementById('recurring-cancel-btn');
            const recurringIdInput = document.getElementById('recurring-id');
            const recurringAmountInput = document.getElementById('recurring-amount');
            const recurringCategoryInput = document.getElementById('recurring-category');
            const recurringNoteInput = document.getElementById('recurring-note');
            const recurringListEl = document.getElementById('recurring-list');
            const currencyLabelRecurringForm = document.getElementById('currency-label-recurring-form');

            // New Category Mgmt Elements
            const categoryForm = document.getElementById('category-form');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const categoryListEl = document.getElementById('category-list');
            const newCategoryIconInput = document.getElementById('new-category-icon');


            // --- MODAL HELPER ---
            const showModal = (title, body, confirmText = 'Confirm', confirmClass = 'bg-red-600 hover:bg-red-700', showCancel = true) => {
                return new Promise((resolve) => {
                    modalTitle.textContent = title;
                    modalBody.innerHTML = body; // Use innerHTML to allow for formatted messages
                    
                    modalConfirmBtn.textContent = confirmText;
                    modalConfirmBtn.className = `px-4 py-2 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 ${confirmClass}`;
                    
                    modalCancelBtn.style.display = showCancel ? 'inline-block' : 'none';

                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    document.body.classList.add('modal-active');
                    
                    const onConfirm = () => {
                        closeModal();
                        resolve(true);
                    };
                    
                    const onCancel = () => {
                        closeModal();
                        resolve(false);
                    };

                    modalConfirmBtn.onclick = onConfirm;
                    modalCancelBtn.onclick = onCancel;
                    modalCloseBtn.onclick = onCancel;
                    modal.querySelector('.modal-backdrop').onclick = onCancel;
                });
            };

            const closeModal = () => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
                // Clean up listeners
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;
                modalCloseBtn.onclick = null;
                modal.querySelector('.modal-backdrop').onclick = null;
            };

            // Show a simple info message
            const showMessage = (title, body) => {
                showModal(title, body, 'OK', 'bg-blue-600 hover:bg-blue-700', false);
            };

            // --- LOADING SPINNER HELPER ---
            const showLoader = () => loadingSpinner.classList.remove('hidden');
            const hideLoader = () => loadingSpinner.classList.add('hidden');
            
            // --- DATA & STORAGE ---
            const saveExpenses = () => {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            };

            const loadExpenses = () => {
                const expensesData = localStorage.getItem('expenses');
                expenses = expensesData ? JSON.parse(expensesData) : [];
            };

            const saveBudgets = () => {
                localStorage.setItem('budgets', JSON.stringify(budgets));
            };

            const loadBudgets = () => {
                const budgetsData = localStorage.getItem('budgets');
                budgets = budgetsData ? JSON.parse(budgetsData) : { baseSalary: 0, categories: {} };
                // Ensure structure is valid
                if (!budgets.categories) {
                    budgets = { baseSalary: budgets.baseSalary || 0, categories: {} };
                }
            };

            const saveSettings = () => {
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
            };

            const loadSettings = () => {
                const settingsData = localStorage.getItem('appSettings');
                appSettings = settingsData ? JSON.parse(settingsData) : { 
                    currency: 'MAD', 
                    darkMode: true, // Default to dark mode
                    categories: defaultCategories,
                    recurringExpenses: []
                };
                if (!appSettings.currency) appSettings.currency = 'MAD';
                if (appSettings.darkMode === undefined) appSettings.darkMode = true; // Default to dark mode
                
                // --- MIGRATION: simple string categories to object categories ---
                if (appSettings.categories && typeof appSettings.categories[0] === 'string') {
                    appSettings.categories = appSettings.categories.map(name => ({
                        name: name,
                        color: CATEGORY_COLORS[name] || getRandomColor()
                    }));
                    
                    // Ensure 'Other' exists
                    if (!appSettings.categories.find(c => c.name === 'Other')) {
                        appSettings.categories.push({ name: 'Other', color: '#A78BFA' });
                    }
                    saveSettings(); // Save the migrated structure
                }
                // --- END MIGRATION ---

                // --- MIGRATION: Add icons if missing ---
                if (appSettings.categories && appSettings.categories.length > 0 && appSettings.categories[0].icon === undefined) {
                    const defaultIconMap = { 'Food': '🍔', 'Bills': '🧾', 'Groceries': '🛒', 'Home Items': '🏠', 'Other': '❓' };
                    appSettings.categories.forEach(cat => {
                        cat.icon = defaultIconMap[cat.name] || '❓';
                    });
                    saveSettings(); // Save the migrated structure
                }
                // --- END MIGRATION ---


                if (!appSettings.categories || appSettings.categories.length === 0) appSettings.categories = defaultCategories;
                if (!appSettings.recurringExpenses) appSettings.recurringExpenses = [];
            };

            // --- DATE HELPERS ---
            const getISODate = (date, dayOffset = 0) => {
                const newDate = new Date(date);
                newDate.setDate(newDate.getDate() + dayOffset);
                return newDate.toISOString().split('T')[0];
            };

            const formatCurrency = (amount) => {
                const currency = appSettings.currency || 'MAD';
                try {
                    return new Intl.NumberFormat('en-US', { 
                        style: 'currency', 
                        currency: currency,
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(amount);
                } catch (e) {
                    // Fallback for invalid currency codes
                    return `${amount.toFixed(2)} ${currency}`;
                }
            };
            
            // --- NEW: COLOR HELPER ---
            const getRandomColor = () => {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            };

            // --- RENDERING ---

            const renderAll = () => {
                // Must run first as other renders depend on it
                populateCategoryDropdowns(); 
                renderExpenseList();
                renderBudgetForms();
                renderBudgetStatus();
                renderDashboard();
                renderRecurringExpensesList();
                renderCategoryList();
            };

            const renderExpenseList = () => {
                expenseListEl.innerHTML = '';
                const filteredExpenses = getFilteredExpenses();

                if (filteredExpenses.length === 0) {
                    expenseListEl.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No expenses found for the selected filters.</td></tr>`;
                    return;
                }
                
                // Sort by date descending
                filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredExpenses.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                    const category = appSettings.categories.find(c => c.name === expense.category);
                    const color = category ? category.color : '#A78BFA'; // Default to purple for 'Other' or missing
                    const icon = category ? (category.icon || '❓') : '❓';

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${expense.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                  style="color: ${color}; background-color: ${color}20;">
                                ${icon} ${expense.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${expense.note || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${expense.id}" class="edit-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">Edit</button>
                            <button data-id="${expense.id}" class="delete-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                        </td>
                    `;
                    expenseListEl.appendChild(tr);
                });
            };
            
            const renderBudgetForms = () => {
                budgetCategoriesFormEl.innerHTML = '';
                baseSalaryInput.value = budgets.baseSalary || '';
                
                appSettings.categories.forEach(category => {
                    const div = document.createElement('div');
                    const budgetValue = budgets.categories[category.name] || '';
                    div.innerHTML = `
                        <label for="budget-${category.name.toLowerCase().replace(' ', '-')}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">${category.icon || '❓'} ${category.name}</label>
                        <input type="number" id="budget-${category.name.toLowerCase().replace(' ', '-')}" 
                               data-category="${category.name}"
                               step="0.01" min="0" value="${budgetValue}" placeholder="0.00" 
                               class="budget-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                    `;
                    budgetCategoriesFormEl.appendChild(div);
                });
            };

            const renderBudgetStatus = () => {
                budgetStatusListEl.innerHTML = '';
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                const monthlyExpenses = expenses.filter(e => e.date >= startOfMonth && e.date <= endOfMonth);
                
                let hasBudgets = false;

                appSettings.categories.forEach(category => {
                    const budgetAmount = budgets.categories[category.name] || 0;
                    if (budgetAmount > 0) {
                        hasBudgets = true;
                        const spentAmount = monthlyExpenses
                            .filter(e => e.category === category.name)
                            .reduce((sum, e) => sum + e.amount, 0);
                        
                        const remaining = budgetAmount - spentAmount;
                        const progress = Math.min(100, (spentAmount / budgetAmount) * 100);
                        
                        let progressBarClass = 'bg-blue-600';
                        let remainingTextClass = 'text-green-600';
                        let remainingText = `${formatCurrency(remaining)} remaining`;

                        if (remaining < 0) {
                            progressBarClass = 'bg-red-600';
                            remainingTextClass = 'text-red-600';
                            remainingText = `${formatCurrency(Math.abs(remaining))} over budget`;
                        } else if (progress > 80) {
                            progressBarClass = 'bg-yellow-500';
                        }
                        
                        const budgetEl = document.createElement('div');
                        budgetEl.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-base font-medium text-gray-800 dark:text-white">${category.icon || '❓'} ${category.name}</span>
                                <span class="text-sm font-medium ${remainingTextClass}">${remainingText}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="${progressBarClass} h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                ${formatCurrency(spentAmount)} / ${formatCurrency(budgetAmount)}
                            </div>
                        `;
                        budgetStatusListEl.appendChild(budgetEl);
                    }
                });

                if (!hasBudgets) {
                    budgetStatusListEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No budgets set. Go to the "Set Budgets" form to add them.</p>`;
                }
            };
            
            const renderDashboard = () => {
                const filteredExpenses = getFilteredExpenses();
                const today = new Date();
                
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // Summaries
                const totalFiltered = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                summaryTotalEl.textContent = formatCurrency(totalFiltered);
                
                const monthExpenses = expenses.filter(e => {
                    const d = new Date(e.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                const totalMonth = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
                summaryMonthEl.textContent = formatCurrency(totalMonth);

                const baseSalary = budgets.baseSalary || 0;
                const remainingSalary = baseSalary - totalMonth;
                summaryRemainingEl.textContent = formatCurrency(remainingSalary);
                if (remainingSalary < 0) {
                    summaryRemainingEl.classList.add('text-red-600');
                } else {
                    summaryRemainingEl.classList.remove('text-red-600');
                }

                const yearExpenses = expenses.filter(e => new Date(e.date).getFullYear() === currentYear);
                const totalYear = yearExpenses.reduce((sum, e) => sum + e.amount, 0);
                summaryYearEl.textContent = formatCurrency(totalYear);

                // Pie Chart
                renderPieChart(filteredExpenses);
                // Line Chart
                renderLineChart(filteredExpenses);
            };

            const renderPieChart = (data) => {
                const ctx = document.getElementById('categoryPieChart').getContext('2d');
                
                const categoryTotals = appSettings.categories.reduce((acc, category) => {
                    acc[category.name] = 0;
                    return acc;
                }, {});

                // Add 'Other' for any expenses with categories no longer in settings
                if (!categoryTotals['Other']) {
                    categoryTotals['Other'] = 0; 
                }

                data.forEach(e => {
                    if (categoryTotals.hasOwnProperty(e.category)) {
                        categoryTotals[e.category] += e.amount;
                    } else {
                        categoryTotals['Other'] += e.amount;
                    }
                });
                
                // Filter out categories with 0 expense
                const chartLabels = Object.keys(categoryTotals).filter(k => categoryTotals[k] > 0);
                const chartDataValues = chartLabels.map(k => categoryTotals[k]);
                const chartColors = chartLabels.map(k => {
                    const category = appSettings.categories.find(c => c.name === k);
                    return category ? category.color : '#A78BFA'; // Default for 'Other'
                });

                const chartData = {
                    labels: chartLabels,
                    datasets: [{
                        data: chartDataValues,
                        backgroundColor: chartColors,
                    }]
                };

                if (categoryPieChart) {
                    categoryPieChart.data = chartData;
                    categoryPieChart.update();
                } else {
                    categoryPieChart = new Chart(ctx, {
                        type: 'pie',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        // This will use Chart.defaults.color
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += formatCurrency(context.parsed);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            };

            const renderLineChart = (data) => {
                const ctx = document.getElementById('spendingLineChart').getContext('2d');
                
                // Group by day
                const dailyTotals = data.reduce((acc, e) => {
                    const date = e.date;
                    acc[date] = (acc[date] || 0) + e.amount;
                    return acc;
                }, {});

                const sortedDates = Object.keys(dailyTotals).sort((a,b) => new Date(a) - new Date(b));
                
                const chartData = {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Spending',
                        data: sortedDates.map(date => dailyTotals[date]),
                        borderColor: '#3B82F6', // blue-500
                        backgroundColor: '#3B82F6' + '30', // blue-500 with opacity
                        fill: true,
                        tension: 0.1
                    }]
                };
                
                if (spendingLineChart) {
                    spendingLineChart.data = chartData;
                    spendingLineChart.update();
                } else {
                    spendingLineChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                        // color will be from Chart.defaults.color
                                    },
                                    grid: {
                                        // color will be from Chart.defaults.borderColor
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 10 // Limit ticks to avoid crowding
                                        // color will be from Chart.defaults.color
                                    },
                                    grid: {
                                        // color will be from Chart.defaults.borderColor
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                                    }
                                }
                            }
                        }
                    });
                }
            };
            
            // --- FILTERING ---
            const getFilteredExpenses = () => {
                return expenses.filter(e => {
                    const date = new Date(e.date);
                    const note = e.note || '';
                    if (filters.startDate && e.date < filters.startDate) return false;
                    if (filters.endDate && e.date > filters.endDate) return false;
                    if (filters.category && e.category !== filters.category) return false;
                    if (filters.searchTerm && !note.toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    return true;
                });
            };

            const handleApplyFilters = () => {
                filters.startDate = filterStartDate.value;
                filters.endDate = filterEndDate.value;
                filters.category = filterCategory.value;
                
                // Re-render dashboard and expense list (if visible)
                renderDashboard();
                renderExpenseList();
            };
            
            const handleResetFilters = () => {
                filters.startDate = '';
                filters.endDate = '';
                filters.category = '';
                
                filterStartDate.value = '';
                filterEndDate.value = '';
                filterCategory.value = '';
                
                // De-activate quick filter buttons
                document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white', 'dark:bg-blue-500');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
                });

                handleApplyFilters();
            };

            // --- EXPENSE CRUD ---
            const handleExpenseFormSubmit = (e) => {
                e.preventDefault();
                
                const id = expenseIdInput.value;
                const expense = {
                    date: expenseDateInput.value,
                    amount: parseFloat(expenseAmountInput.value),
                    category: expenseCategoryInput.value,
                    note: expenseNoteInput.value.trim()
                };

                if (id) {
                    // Update
                    const index = expenses.findIndex(e => e.id === id);
                    if (index !== -1) {
                        expenses[index] = { ...expenses[index], ...expense };
                    }
                } else {
                    // Add new
                    expense.id = crypto.randomUUID();
                    expenses.push(expense);
                }
                
                saveExpenses();
                renderAll();
                resetExpenseForm();
                showMessage('Success', `Expense successfully ${id ? 'updated' : 'added'}!`);
            };

            const resetExpenseForm = () => {
                expenseForm.reset();
                expenseIdInput.value = '';
                expenseFormTitle.textContent = 'Add New Expense';
                expenseSubmitBtn.textContent = 'Add Expense';
                expenseCancelBtn.classList.add('hidden');
                expenseDateInput.value = getISODate(new Date()); // Default to today
            };
            
            const handleEditExpense = (id) => {
                const expense = expenses.find(e => e.id === id);
                if (!expense) return;

                expenseIdInput.value = expense.id;
                expenseDateInput.value = expense.date;
                expenseAmountInput.value = expense.amount;
                expenseCategoryInput.value = expense.category;
                expenseNoteInput.value = expense.note;

                expenseFormTitle.textContent = 'Edit Expense';
                expenseSubmitBtn.textContent = 'Update Expense';
                expenseCancelBtn.classList.remove('hidden');
                
                // Switch to expense tab and scroll to form
                showSection('expenses');
                expenseForm.scrollIntoView({ behavior: 'smooth' });
            };

            const handleDeleteExpense = async (id) => {
                const confirmed = await showModal('Delete Expense', 'Are you sure you want to delete this expense? This action cannot be undone.', 'Delete', 'bg-red-600 hover:bg-red-700');
                
                if (confirmed) {
                    expenses = expenses.filter(e => e.id !== id);
                    saveExpenses();
                    renderAll();
                    showMessage('Deleted', 'The expense has been deleted.');
                }
            };

            // --- BUDGETS ---
            const handleBudgetFormSubmit = (e) => {
                e.preventDefault();
                
                const newCategoryBudgets = {};
                document.querySelectorAll('#budget-categories-form .budget-input').forEach(input => {
                    const category = input.dataset.category;
                    newCategoryBudgets[category] = parseFloat(input.value) || 0;
                });

                budgets = {
                    baseSalary: parseFloat(baseSalaryInput.value) || 0,
                    categories: newCategoryBudgets
                };

                saveBudgets();
                renderBudgetStatus(); // Re-render status immediately
                renderDashboard(); // Re-render dashboard summaries
                showMessage('Success', 'Budgets have been saved.');
            };

            // --- DATA IMPORT/EXPORT ---
            const handleExportCSV = () => {
                if (expenses.length === 0) {
                    showMessage('No Data', 'There are no expenses to export.');
                    return;
                }
                
                const headers = 'id,date,amount,category,note\n';
                const csv = expenses.map(e => {
                    const note = `"${e.note ? e.note.replace(/"/g, '""') : ''}"`;
                    return `${e.id},${e.date},${e.amount},${e.category},${note}`;
                }).join('\n');
                
                const csvBlob = new Blob([headers + csv], { type: 'text/csv;charset=utf-8;' });
                const csvUrl = URL.createObjectURL(csvBlob);
                const link = document.createElement('a');
                link.setAttribute('href', csvUrl);
                link.setAttribute('download', `expenses_${getISODate(new Date())}.csv`);
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportCSV = (file) => {
                if (!file) return;
                
                showLoader();
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    const headers = lines.shift().trim().split(',');

                    // Simple header validation
                    const requiredHeaders = ['id', 'date', 'amount', 'category', 'note'];
                    if (!requiredHeaders.every((h, i) => headers[i] === h)) {
                        hideLoader();
                        showMessage('Import Error', 'Invalid CSV format. Headers must be: `id,date,amount,category,note`');
                        return;
                    }
                    
                    const newExpenses = [];
                    let parseError = false;
                    
                    for (const line of lines) {
                        // Basic CSV parsing (not robust for all edge cases, but fine for this app)
                        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
                                        .map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
                                        
                        if (values.length !== 5) {
                            parseError = true;
                            break;
                        }

                        const [id, date, amount, category, note] = values;
                        const parsedAmount = parseFloat(amount);
                        
                        if (id && date && !isNaN(parsedAmount) && category) {
                            newExpenses.push({
                                id,
                                date,
                                amount: parsedAmount,
                                category,
                                note
                            });
                        } else {
                            parseError = true;
                            break;
                        }
                    }

                    if (parseError) {
                        hideLoader();
                        showMessage('Import Error', 'Error parsing CSV file. Please check the data and format.');
                        return;
                    }
                    
                    const importMode = document.querySelector('input[name="import-mode"]:checked').value;
                    const confirmed = await showModal(
                        'Confirm Import', 
                        `Found ${newExpenses.length} expenses. Do you want to <strong>${importMode}</strong> them with your current data?`,
                        'Confirm Import',
                        'bg-blue-600 hover:bg-blue-700'
                    );

                    if (confirmed) {
                        if (importMode === 'replace') {
                            expenses = newExpenses;
                        } else {
                            // Merge: Add new, update existing based on ID
                            newExpenses.forEach(newExp => {
                                const index = expenses.findIndex(e => e.id === newExp.id);
                                if (index !== -1) {
                                    expenses[index] = newExp; // Update
                                } else {
                                    expenses.push(newExp); // Add
                                }
                            });
                        }
                        saveExpenses();
                        renderAll();
                        hideLoader();
                        showMessage('Success', `Successfully imported ${newExpenses.length} expenses.`);
                    } else {
                        hideLoader();
                    }
                };
                
                reader.onerror = () => {
                    hideLoader();
                    showMessage('Import Error', 'Could not read the file.');
                };
                
                reader.readAsText(file);
            };
            
            const handleDeleteAllData = async () => {
                const confirmed = await showModal(
                    'Delete All Data', 
                    '<strong>Are you absolutely sure?</strong> This will delete all expenses and budgets permanently. This action cannot be undone.', 
                    'Yes, Delete Everything', 
                    'bg-red-600 hover:bg-red-700'
                );

                if (confirmed) {
                    expenses = [];
                    budgets = { baseSalary: 0, categories: {} };
                    appSettings.categories = defaultCategories;
                    appSettings.recurringExpenses = [];
                    saveExpenses();
                    saveBudgets();
                    saveSettings();
                    renderAll();
                    showMessage('Data Deleted', 'All expenses, budgets, and custom categories have been deleted.');
                }
            };

            // --- NEW: RECURRING EXPENSES ---
            const renderRecurringExpensesList = () => {
                recurringListEl.innerHTML = '';
                const today = new Date();
                const currentMonthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

                if (appSettings.recurringExpenses.length === 0) {
                    recurringListEl.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No recurring expenses found.</td></tr>`;
                    return;
                }
                
                appSettings.recurringExpenses.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                    const category = appSettings.categories.find(c => c.name === item.category);
                    const color = category ? category.color : '#A78BFA';
                    const icon = category ? (category.icon || '❓') : '❓';
                    
                    const isAdded = item.lastAdded === currentMonthYear;

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(item.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                  style="color: ${color}; background-color: ${color}20;">
                                ${icon} ${item.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.note}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.lastAdded === '2000-01' ? 'Never' : item.lastAdded}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button data-id="${item.id}" class="recurring-add-btn px-3 py-1 text-xs rounded-full ${isAdded ? 'bg-green-600 text-white cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}" ${isAdded ? 'disabled' : ''}>
                                ${isAdded ? 'Added' : 'Add'}
                            </button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${item.id}" class="recurring-edit-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">Edit</button>
                            <button data-id="${item.id}" class="recurring-delete-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                        </td>
                    `;
                    recurringListEl.appendChild(tr);
                });
            };

            const handleRecurringFormSubmit = (e) => {
                e.preventDefault();
                
                const id = recurringIdInput.value;
                const recurringItem = {
                    amount: parseFloat(recurringAmountInput.value),
                    category: recurringCategoryInput.value,
                    note: recurringNoteInput.value.trim()
                };

                if (id) {
                    // Update
                    const index = appSettings.recurringExpenses.findIndex(item => item.id === id);
                    if (index !== -1) {
                        // Preserve lastAdded date
                        recurringItem.lastAdded = appSettings.recurringExpenses[index].lastAdded;
                        recurringItem.id = id;
                        appSettings.recurringExpenses[index] = recurringItem;
                    }
                } else {
                    // Add new
                    recurringItem.id = crypto.randomUUID();
                    recurringItem.lastAdded = '2000-01'; // Set to 'Never'
                    appSettings.recurringExpenses.push(recurringItem);
                }
                
                saveSettings();
                renderRecurringExpensesList();
                resetRecurringForm();
                showMessage('Success', `Recurring expense successfully ${id ? 'updated' : 'added'}!`);
            };

            const resetRecurringForm = () => {
                recurringForm.reset();
                recurringIdInput.value = '';
                recurringFormTitle.textContent = 'Add Recurring Expense';
                recurringSubmitBtn.textContent = 'Add Recurring';
                recurringCancelBtn.classList.add('hidden');
            };

            const handleEditRecurring = (id) => {
                const item = appSettings.recurringExpenses.find(item => item.id === id);
                if (!item) return;

                recurringIdInput.value = item.id;
                recurringAmountInput.value = item.amount;
                recurringCategoryInput.value = item.category;
                recurringNoteInput.value = item.note;

                recurringFormTitle.textContent = 'Edit Recurring Expense';
                recurringSubmitBtn.textContent = 'Update Recurring';
                recurringCancelBtn.classList.remove('hidden');
                
                recurringForm.scrollIntoView({ behavior: 'smooth' });
            };

            const handleDeleteRecurring = async (id) => {
                const confirmed = await showModal('Delete Recurring Expense', 'Are you sure you want to delete this recurring expense?', 'Delete', 'bg-red-600 hover:bg-red-700');
                
                if (confirmed) {
                    appSettings.recurringExpenses = appSettings.recurringExpenses.filter(item => item.id !== id);
                    saveSettings();
                    renderRecurringExpensesList();
                    showMessage('Deleted', 'The recurring expense has been deleted.');
                }
            };
            
            const handleAddRecurring = (id) => {
                const item = appSettings.recurringExpenses.find(item => item.id === id);
                if (!item) return;

                const today = new Date();
                const currentMonthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (item.lastAdded === currentMonthYear) {
                    showMessage('Already Added', 'This item has already been added for this month.');
                    return;
                }

                const newExpense = {
                    id: crypto.randomUUID(),
                    date: `${currentMonthYear}-01`, // Add on the 1st of the month
                    amount: item.amount,
                    category: item.category,
                    note: `${item.note} (Recurring)`
                };
                expenses.push(newExpense);
                item.lastAdded = currentMonthYear;
                
                saveExpenses();
                saveSettings();
                renderAll();
                showMessage('Success', `Added "${item.note}" to expenses for this month.`);
            };

            // --- NEW: CATEGORY MANAGEMENT ---
            const renderCategoryList = () => {
                categoryListEl.innerHTML = '';
                appSettings.categories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-md dark:bg-gray-700';
                    li.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span data-name="${category.name}" class="category-icon-btn text-xl w-6 text-center cursor-pointer" title="Edit Icon">${category.icon || '❓'}</span>
                            <input type="color" data-name="${category.name}" value="${category.color}" class="category-color-picker">
                            <span class="text-gray-800 dark:text-gray-200">${category.name}</span>
                        </div>
                        <div class="space-x-2">
                            <button data-name="${category.name}" class="category-edit-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 ${category.name === 'Other' ? 'hidden' : ''}">Edit</button>
                            <button data-name="${category.name}" class="category-delete-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 ${category.name === 'Other' ? 'hidden' : ''}">Delete</button>
                        </div>
                    `;
                    categoryListEl.appendChild(li);
                });
            };

            const handleCategoryFormSubmit = (e) => {
                e.preventDefault();
                const newName = newCategoryNameInput.value.trim();
                const newIcon = newCategoryIconInput.value.trim() || '❓';
                if (newName && !appSettings.categories.find(c => c.name.toLowerCase() === newName.toLowerCase())) {
                    appSettings.categories.push({ name: newName, icon: newIcon, color: getRandomColor() });
                    saveSettings();
                    renderAll();
                    newCategoryNameInput.value = '';
                    newCategoryIconInput.value = '';
                } else if (!newName) {
                    showMessage('Error', 'Category name cannot be empty.');
                } else {
                    showMessage('Error', 'This category already exists.');
                }
            };

            const handleEditCategory = async (oldName) => {
                const newName = prompt(`Enter new name for "${oldName}":`, oldName);

                if (newName && newName.trim() !== '' && newName !== oldName) {
                    const newNameTrimmed = newName.trim();
                    if (appSettings.categories.find(c => c.name.toLowerCase() === newNameTrimmed.toLowerCase())) {
                        showMessage('Error', 'This category name already exists.');
                        return;
                    }

                    // 1. Update in settings
                    const category = appSettings.categories.find(c => c.name === oldName);
                    if (category) {
                        category.name = newNameTrimmed;
                    }
                    
                    // 2. Update in all expenses
                    expenses.forEach(expense => {
                        if (expense.category === oldName) {
                            expense.category = newNameTrimmed;
                        }
                    });

                    // 3. Update in all budgets
                    if (budgets.categories[oldName]) {
                        budgets.categories[newNameTrimmed] = budgets.categories[oldName];
                        delete budgets.categories[oldName];
                    }

                    // 4. Update in recurring expenses
                    appSettings.recurringExpenses.forEach(item => {
                        if (item.category === oldName) {
                            item.category = newNameTrimmed;
                        }
                    });

                    saveSettings();
                    saveExpenses();
                    saveBudgets();
                    renderAll();
                    showMessage('Success', `Category "${oldName}" renamed to "${newNameTrimmed}".`);
                }
            };
            
            const handleEditCategoryIcon = (name) => {
                const category = appSettings.categories.find(c => c.name === name);
                if (!category) return;

                const newIcon = prompt(`Enter new icon (emoji) for "${name}":`, category.icon);

                if (newIcon && newIcon.trim() !== '') {
                    category.icon = newIcon.trim();
                    saveSettings();
                    renderAll(); // Re-render to show new icon everywhere
                }
            };
            
            // --- NAVIGATION ---
            const showSection = (hash) => {
                const id = hash.substring(1); // remove '#'
                appSections.forEach(section => {
                    if (section.id === id) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });

                // Update nav link styles
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === hash) {
                        link.classList.add('text-blue-600', 'dark:text-blue-400');
                        link.classList.remove('text-gray-700', 'dark:text-gray-300');
                    } else {
                        link.classList.remove('text-blue-600', 'dark:text-blue-400');
                        link.classList.add('text-gray-700', 'dark:text-gray-300');
                    }
                });
                
                // Close mobile menu
                mobileMenu.classList.add('hidden');
            };

            const handleNavClick = (e) => {
                e.preventDefault();
                const hash = e.currentTarget.getAttribute('href');
                if (hash) {
                    window.location.hash = hash;
                }
            };
            
            // --- EVENT LISTENERS ---
            // Navigation
            navLinks.forEach(link => link.addEventListener('click', handleNavClick));
            
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Handle hash changes (e.g., back/forward buttons)
            window.addEventListener('hashchange', () => {
                showSection(window.location.hash || '#dashboard');
            });

            // Filters
            applyFiltersBtn.addEventListener('click', handleApplyFilters);
            resetFiltersBtn.addEventListener('click', handleResetFilters);

            // --- NEW: Quick Filter Listeners ---
            const quickFilterButtons = [
                { btn: quickFilterWeekBtn, type: 'week' },
                { btn: quickFilterMonthBtn, type: 'month' },
                { btn: quickFilterLastMonthBtn, type: 'last-month' },
                { btn: quickFilterYearBtn, type: 'year' }
            ];

            quickFilterButtons.forEach(({ btn, type }) => {
                btn.addEventListener('click', () => {
                    // De-activate all buttons first
                    document.querySelectorAll('.quick-filter-btn').forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white', 'dark:bg-blue-500');
                        b.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
                    });
                    // Activate this one
                    btn.classList.add('bg-blue-600', 'text-white', 'dark:bg-blue-500');
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');

                    const today = new Date();
                    let startDate, endDate = getISODate(today);

                    switch (type) {
                        case 'week':
                            const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                            startDate = getISODate(firstDayOfWeek);
                            break;
                        case 'month':
                            startDate = getISODate(new Date(today.getFullYear(), today.getMonth(), 1));
                            break;
                        case 'last-month':
                            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            startDate = getISODate(lastMonth);
                            endDate = getISODate(new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0));
                            break;
                        case 'year':
                            startDate = getISODate(new Date(today.getFullYear(), 0, 1));
                            break;
                    }

                    filterStartDate.value = startDate;
                    filterEndDate.value = endDate;
                    filterCategory.value = ''; // Reset category
                    handleApplyFilters();
                });
            });

            // Search
            searchBar.addEventListener('input', (e) => {
                filters.searchTerm = e.target.value;
                renderExpenseList();
            });

            // Expense Form
            expenseForm.addEventListener('submit', handleExpenseFormSubmit);
            expenseCancelBtn.addEventListener('click', resetExpenseForm);
            
            // Expense List Actions (Event Delegation)
            expenseListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    handleEditExpense(e.target.dataset.id);
                }
                if (e.target.classList.contains('delete-btn')) {
                    handleDeleteExpense(e.target.dataset.id);
                }
            });

            // Budget Form
            budgetForm.addEventListener('submit', handleBudgetFormSubmit);

            // Recurring Expense Form
            recurringForm.addEventListener('submit', handleRecurringFormSubmit);
            recurringCancelBtn.addEventListener('click', resetRecurringForm);

            // Recurring List Actions
            recurringListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('recurring-edit-btn')) {
                    handleEditRecurring(e.target.dataset.id);
                }
                if (e.target.classList.contains('recurring-delete-btn')) {
                    handleDeleteRecurring(e.target.dataset.id);
                }
                if (e.target.classList.contains('recurring-add-btn')) {
                    handleAddRecurring(e.target.dataset.id);
                }
            });
            
            // Category Management
            categoryForm.addEventListener('submit', handleCategoryFormSubmit);
            categoryListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-edit-btn')) {
                    handleEditCategory(e.target.dataset.name);
                }
                if (e.target.classList.contains('category-delete-btn')) {
                    handleDeleteCategory(e.target.dataset.name);
                }
                if (e.target.classList.contains('category-icon-btn')) {
                    handleEditCategoryIcon(e.target.dataset.name);
                }
            });
            // NEW: Listen for color changes
            categoryListEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('category-color-picker')) {
                    const categoryName = e.target.dataset.name;
                    const newColor = e.target.value;
                    const category = appSettings.categories.find(c => c.name === categoryName);
                    if (category) {
                        category.color = newColor;
                        saveSettings();
                        renderAll(); // Re-render to show new colors
                    }
                }
            });
            
            // Data Management
            exportCsvBtn.addEventListener('click', handleExportCSV);
            deleteAllDataBtn.addEventListener('click', handleDeleteAllData);
            
            importCsvInput.addEventListener('change', (e) => {
                importCsvBtn.disabled = !e.target.files || e.target.files.length === 0;
            });
            
            importCsvBtn.addEventListener('click', () => {
                handleImportCSV(importCsvInput.files[0]);
                importCsvInput.value = ''; // Reset file input
                importCsvBtn.disabled = true;
            });

            // Settings
            currencyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                appSettings.currency = currencySelect.value;
                saveSettings();
                updateCurrencyUI();
                renderAll(); // Re-render all to update currency formatting
                showMessage('Success', 'Currency saved.');
            });

            darkModeToggle.addEventListener('click', () => {
                appSettings.darkMode = !appSettings.darkMode;
                saveSettings(); // Save the new setting
                updateDarkModeUI(appSettings.darkMode); // Update UI immediately
            });


            // --- UI HELPERS ---
            const updateCurrencyUI = () => {
                const currency = appSettings.currency || 'MAD';
                currencyLabelForm.textContent = `(${currency})`;
                currencyLabelRecurringForm.textContent = `(${currency})`;
                // Update placeholder for base salary
                baseSalaryInput.placeholder = `0.00`;
                // Update placeholders for budget inputs
                document.querySelectorAll('.budget-input').forEach(input => {
                    input.placeholder = `0.00`;
                });
                // Update placeholder for expense amount
                expenseAmountInput.placeholder = `0.00`;
                // Update placeholder for recurring amount
                recurringAmountInput.placeholder = `0.00`;
            };

            const populateCategoryDropdowns = () => {
                const selects = [filterCategory, expenseCategoryInput, recurringCategoryInput];
                
                selects.forEach(select => {
                    if (!select) return;
                    
                    // Preserve the first option (e.g., "All Categories") if it exists
                    const firstOption = select.options[0] ? select.options[0].cloneNode(true) : null;
                    select.innerHTML = '';
                    if (firstOption && firstOption.value === "") {
                        select.appendChild(firstOption);
                    }

                    appSettings.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = `${category.icon || '❓'} ${category.name}`;
                        select.appendChild(option);
                    });
                });
            };

            const updateDarkModeUI = (isDark) => {
                const htmlEl = document.documentElement;
                if (isDark) {
                    htmlEl.classList.add('dark');
                    darkModeToggle.setAttribute('aria-checked', 'true');
                    darkModeDot.classList.add('translate-x-5');
                    darkModeDot.classList.remove('translate-x-0');
                    darkModeToggle.classList.add('bg-blue-600');
                    darkModeToggle.classList.remove('bg-gray-200');
                    // Update Chart.js defaults
                    Chart.defaults.color = '#D1D5DB'; // gray-300
                    Chart.defaults.borderColor = '#4B5563'; // gray-600
                } else {
                    htmlEl.classList.remove('dark');
                    darkModeToggle.setAttribute('aria-checked', 'false');
                    darkModeDot.classList.remove('translate-x-5');
                    darkModeDot.classList.add('translate-x-0');
                    darkModeToggle.classList.remove('bg-blue-600');
                    darkModeToggle.classList.add('bg-gray-200');
                    // Update Chart.js defaults
                    Chart.defaults.color = '#6B7280'; // gray-500
                    Chart.defaults.borderColor = '#E5E7EB'; // gray-200
                }
                
                // Force charts to re-render with new colors
                if (categoryPieChart) categoryPieChart.update();
                if (spendingLineChart) spendingLineChart.update();
            };


            // --- INITIALIZATION ---
            const init = () => {
                loadExpenses();
                loadSettings();
                loadBudgets();
                
                expenseDateInput.value = getISODate(new Date()); // Set default date
                currencySelect.value = appSettings.currency; // Set currency dropdown
                updateCurrencyUI();
                updateDarkModeUI(appSettings.darkMode); // Set initial dark mode state
                
                // Set initial section based on hash or default to dashboard
                showSection(window.location.hash || '#dashboard');
                
                // Initial render
                renderAll();
            };

            init();
        });
    </script>
</body>
</html>






