<!DOCTYPE html>
<html lang="en" class=""> <!-- class="light" will be toggled here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Expense Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        :root {
            --bg-primary: #1C1C1E;
            --bg-secondary: rgba(44, 44, 46, 0.7);
            --bg-tertiary: rgba(60, 60, 62, 0.7);
            --bg-overlay: rgba(0, 0, 0, 0.6);
            --text-primary: #FFFFFF;
            --text-secondary: #E5E5E7;
            --text-tertiary: #A1A1AA;
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-focus: rgba(59, 130, 246, 0.7);
            --scroll-track: #1C1C1E;
            --scroll-thumb: #3C3C3E;
            --scroll-thumb-hover: #5C5C5E;
        }

        .light {
            --bg-primary: #F3F4F6;
            --bg-secondary: rgba(255, 255, 255, 0.7);
            --bg-tertiary: rgba(230, 230, 230, 0.7);
            --bg-overlay: rgba(0, 0, 0, 0.4);
            --text-primary: #111827;
            --text-secondary: #1F2937;
            --text-tertiary: #4B5563;
            --border-primary: rgba(0, 0, 0, 0.1);
            --border-focus: rgba(59, 130, 246, 0.7);
            --scroll-track: #F3F4F6;
            --scroll-thumb: #D1D5DB;
            --scroll-thumb-hover: #9CA3AF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: 1.25rem; /* 20px */
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Glassmorphism Input Style */
        .glass-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .glass-input::placeholder {
            color: var(--text-tertiary);
        }
        .glass-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scroll-thumb-hover); }

        /* Date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: var(--bg-primary) = #1C1C1E ? invert(1) : invert(0);
            cursor: pointer;
        }
        
        /* Modal animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-slide-in-up { animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Bar chart animation */
        .chart-bar { transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Budget progress bar */
        #budget-progress-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Pie chart */
        #pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #F9C851 0deg 90deg, #E67E22 90deg 180deg, #3498DB 180deg 270deg, #2ECC71 270deg 360deg);
            transition: background 0.5s;
        }
        
        /* Utility for hiding */
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-6xl mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 md:mb-8 gap-4">
            <div class="flex-1 flex items-center gap-4">
                <h1 class="text-3xl md:text-4xl font-bold text-primary tracking-tight text-white">
                    My Expenses
                </h1>
                <select id="month-selector" class="glass-input text-sm rounded-lg py-2 px-3 focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle-btn" class="p-2 rounded-full glass-input" title="Toggle Theme">
                    <!-- Sun Icon -->
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <!-- Moon Icon -->
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <button id="set-budget-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-medium py-2 px-4 rounded-full flex items-center gap-2 transition-all duration-200 shadow-lg shadow-teal-600/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16v2m-6-6H3m6 0H9m6 0h3m-3 0h-3m-6 0H3m6 0H9m6 0h3m-3 0h-3" />
                    </svg>
                    <span class="hidden sm:inline">Budget</span>
                </button>
                <button id="add-expense-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-full flex items-center gap-2 transition-all duration-200 shadow-lg shadow-blue-600/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">Add Expense</span>
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">

            <!-- Main Column (Summary, Chart, List) -->
            <div class="lg:col-span-2 space-y-6 md:space-y-8">
                
                <!-- Total Expenses Card -->
                <section class="glass-card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-sm font-medium text-tertiary mb-2">
                                Total This Month
                            </h2>
                            <div class="text-4xl md:text-5xl font-bold text-primary" id="total-expenses">
                                0.00 MAD
                            </div>
                        </div>
                        <div class="text-right">
                            <h2 class="text-sm font-medium text-tertiary mb-2">
                                Budget
                            </h2>
                            <div class="text-2xl font-semibold text-primary" id="budget-display">
                                Not Set
                            </div>
                        </div>
                    </div>
                    <!-- Budget Progress Bar -->
                    <div class="mt-4">
                        <div class="w-full bg-tertiary/30 rounded-full h-2.5">
                            <div id="budget-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="budget-remaining-text" class="text-sm text-tertiary text-right mt-1"></p>
                    </div>
                </section>
                
                <!-- Monthly Breakdown Card -->
                <section class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-primary">
                            Monthly Breakdown
                        </h3>
                        <div class="flex gap-2">
                            <button id="chart-toggle-bar" class="p-2 rounded-lg glass-input bg-blue-600/30 text-blue-300" title="Bar Chart">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            </button>
                            <button id="chart-toggle-pie" class="p-2 rounded-lg glass-input" title="Pie Chart">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Chart Area -->
                    <div id="bar-chart-container" class="h-48 w-full flex justify-around items-end gap-2 p-4 bg-tertiary/20 rounded-xl">
                        <!-- Bar chart bars will be injected here -->
                    </div>
                    <div id="pie-chart-container" class="h-48 w-full hidden justify-center items-center gap-6 p-4 bg-tertiary/20 rounded-xl">
                        <div id="pie-chart"></div>
                        <div id="pie-chart-legend" class="text-sm space-y-1"></div>
                    </div>
                </section>
                
                <!-- Expense List -->
                <section>
                    <div class="flex justify-between items-center mb-4 gap-4 flex-wrap">
                        <h2 class="text-2xl font-semibold text-primary">
                            History
                        </h2>
                        <div class="flex gap-2 flex-wrap">
                            <input type="search" id="search-bar" class="glass-input text-sm rounded-lg py-2 px-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Search expenses...">
                            <select id="filter-category" class="glass-input text-sm rounded-lg py-2 px-3 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Filter options will be injected here -->
                            </select>
                            <button id="export-csv-btn" class="glass-input p-2 rounded-lg" title="Export to CSV">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    </div>

                    <div id="expense-list" class="space-y-3">
                        <!-- Expense items will be injected here -->
                        <div id="empty-state" class="glass-card p-6 text-center text-tertiary">
                            <p>No expenses recorded for this month yet.</p>
                            <p class="text-sm">Click "Add Expense" to get started.</p>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Right Column (Insights) -->
            <div class="lg:col-span-1 space-y-6 md:space-y-8">
                <section class="glass-card p-6">
                    <h2 class="text-lg font-semibold text-primary mb-4">
                        Monthly Insights
                    </h2>
                    <div class="space-y-4">
                        <div id="insight-top-category">
                            <h3 class="text-sm font-medium text-tertiary">TOP CATEGORY</h3>
                            <p class="text-xl font-semibold text-primary">--</p>
                        </div>
                        <div id="insight-highest-expense">
                            <h3 class="text-sm font-medium text-tertiary">HIGHEST EXPENSE</h3>
                            <p class="text-xl font-semibold text-primary">0.00 MAD</p>
                            <p class="text-sm text-tertiary truncate">--</p>
                        </div>
                        <div id="insight-avg-spend">
                            <h3 class="text-sm font-medium text-tertiary">AVG. DAILY SPEND</h3>
                            <p class="text-xl font-semibold text-primary">0.00 MAD</p>
                        </div>
                    </div>
                </section>
                <section class="glass-card p-6">
                    <button id="manage-categories-btn" class="w-full text-center bg-blue-600/20 text-blue-300 hover:bg-blue-600/40 font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        Manage Categories
                    </button>
                </section>
            </div>

        </div>
    </div>

    <!-- Modals -->

    <!-- Add/Edit Expense Modal -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-overlay backdrop-blur-sm modal-fade-in" id="modal-backdrop"></div>
        <div class="glass-card z-10 w-full max-w-md p-6 modal-slide-in-up">
            <h3 id="modal-title" class="text-2xl font-semibold text-primary mb-6">Add New Expense</h3>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id">
                <div>
                    <label for="expense-title" class="block text-sm font-medium text-tertiary mb-2">Description</label>
                    <input type="text" id="expense-title" class="glass-input w-full rounded-lg p-3" placeholder="e.g., Weekly Groceries" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-tertiary mb-2">Amount (MAD)</label>
                        <input type="number" id="expense-amount" class="glass-input w-full rounded-lg p-3" placeholder="150.00" min="0.01" step="0.01" required>
                    </div>
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-tertiary mb-2">Category</label>
                        <select id="expense-category" class="glass-input w-full rounded-lg p-3 h-[46px]" required>
                            <!-- Category options will be injected here -->
                        </select>
                    </div>
                </div>
                <div>
                    <label for="expense-date" class="block text-sm font-medium text-tertiary mb-2">Date</label>
                    <input type="date" id="expense-date" class="glass-input w-full rounded-lg p-3" required>
                </div>
                <div class="flex items-center justify-between">
                    <label for="expense-recurring" class="flex items-center gap-2 text-sm text-tertiary cursor-pointer">
                        <input type="checkbox" id="expense-recurring" class="glass-input rounded text-blue-600 focus:ring-blue-500">
                        Set as recurring (monthly)
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-btn" class="bg-tertiary/80 hover:bg-tertiary text-primary font-medium py-2 px-5 rounded-full transition-colors duration-200">Cancel</button>
                    <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-5 rounded-full transition-colors duration-200 shadow-lg shadow-blue-600/30">Save Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div id="budget-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-overlay backdrop-blur-sm modal-fade-in" id="budget-modal-backdrop"></div>
        <div class="glass-card z-10 w-full max-w-sm p-6 modal-slide-in-up">
            <h3 class="text-2xl font-semibold text-primary mb-6">Set Monthly Budget</h3>
            <form id="budget-form" class="space-y-4">
                <div>
                    <label for="budget-amount" class="block text-sm font-medium text-tertiary mb-2">Budget Amount (MAD)</label>
                    <input type="number" id="budget-amount" class="glass-input w-full rounded-lg p-3" placeholder="5000.00" min="0" step="100">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="budget-cancel-btn" class="bg-tertiary/80 hover:bg-tertiary text-primary font-medium py-2 px-5 rounded-full transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white font-medium py-2 px-5 rounded-full transition-colors duration-200 shadow-lg shadow-teal-600/30">Set Budget</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-overlay backdrop-blur-sm modal-fade-in" id="delete-modal-backdrop"></div>
        <div class="glass-card z-10 w-full max-w-sm p-6 modal-slide-in-up">
            <h3 class="text-xl font-semibold text-primary mb-4">Delete Expense</h3>
            <p class="text-tertiary mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="delete-cancel-btn" class="bg-tertiary/80 hover:bg-tertiary text-primary font-medium py-2 px-5 rounded-full transition-colors duration-200">Cancel</button>
                <button type="button" id="delete-confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-5 rounded-full transition-colors duration-200 shadow-lg shadow-red-600/30">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="fixed inset-0 bg-overlay backdrop-blur-sm modal-fade-in" id="category-modal-backdrop"></div>
        <div class="glass-card z-10 w-full max-w-md p-6 modal-slide-in-up">
            <h3 class="text-2xl font-semibold text-primary mb-6">Manage Categories</h3>
            <form id="category-form" class="flex gap-2 mb-4">
                <input type="text" id="category-name-input" class="glass-input w-full rounded-lg p-3" placeholder="New category name" required>
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">Add</button>
            </form>
            <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- Category list will be injected here -->
            </div>
            <div class="flex justify-end gap-3 pt-6">
                <button type="button" id="category-close-btn" class="bg-tertiary/80 hover:bg-tertiary text-primary font-medium py-2 px-5 rounded-full transition-colors duration-200">Done</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        // --- STORAGE KEYS ---
        const KEYS = {
            EXPENSES: 'householdExpenses',
            RECURRING: 'recurringExpenses',
            BUDGET: 'monthlyBudget',
            THEME: 'appTheme',
            CATEGORIES: 'expenseCategories'
        };

        // --- DEFAULT CATEGORIES (if storage is empty) ---
        const DEFAULT_CATEGORIES = {
            food: { label: 'Food', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2zm0 0h18M5 7h14M5 11h7" /></svg>` },
            water: { label: 'Water', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.472 15.03L3 12.56C3 12.23 3.23 12 3.56 12H5.44C5.77 12 6 12.23 6 12.56L8.53 15.03C8.72 15.22 9 15.09 9 14.82V3.5C9 3.22 8.78 3 8.5 3H3.5C3.22 3 3 3.22 3 3.5V14.82C3 15.09 3.28 15.22 3.47 15.03L5.472 15.03zM18.53 15.03L21 12.56C21 12.23 20.77 12 20.44 12H18.56C18.23 12 18 12.23 18 12.56L15.47 15.03C15.28 15.22 15 15.09 15 14.82V3.5C15 3.22 15.22 3 15.5 3H20.5C20.78 3 21 3.22 21 3.5V14.82C21 15.09 20.72 15.22 20.53 15.03L18.53 15.03zM12 10.5C12.83 10.5 13.5 9.83 13.5 9C13.5 8.17 12.83 7.5 12 7.5S10.5 8.17 10.5 9C10.5 9.83 11.17 10.5 12 10.5zM12 21C15.31 21 18 18.31 18 15V12H6V15C6 18.31 8.69 21 12 21z" /></svg>` },
            electricity: { label: 'Electricity', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>` },
            rent: { label: 'Rent', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4z" /></svg>` },
            transport: { label: 'Transport', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>` },
            other: { label: 'Other', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12S5.477 2 11 2s10 4.477 10 10z" /></svg>` }
        };
        const GENERIC_ICON = DEFAULT_CATEGORIES.other.icon;

        // --- STATE ---
        let expenses = [];
        let recurringExpenses = [];
        let categories = {};
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentBudget = 0;
        let chartType = 'bar';
        let expenseToDeleteId = null;

        // --- DOM ELEMENTS ---
        const docElement = document.documentElement;
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const expenseListEl = document.getElementById('expense-list');
        const totalExpensesEl = document.getElementById('total-expenses');
        const filterCategoryEl = document.getElementById('filter-category');
        const emptyStateEl = document.getElementById('empty-state');
        
        // Expense Modal
        const modal = document.getElementById('modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const cancelBtn = document.getElementById('cancel-btn');
        const expenseForm = document.getElementById('expense-form');
        const expenseIdField = document.getElementById('expense-id');
        const expenseTitleField = document.getElementById('expense-title');
        const expenseAmountField = document.getElementById('expense-amount');
        const expenseCategoryField = document.getElementById('expense-category');
        const expenseDateField = document.getElementById('expense-date');
        const expenseRecurringCheckbox = document.getElementById('expense-recurring');

        // Theme Toggle
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        
        // Month Selector
        const monthSelector = document.getElementById('month-selector');
        
        // Budget
        const setBudgetBtn = document.getElementById('set-budget-btn');
        const budgetModal = document.getElementById('budget-modal');
        const budgetModalBackdrop = document.getElementById('budget-modal-backdrop');
        const budgetForm = document.getElementById('budget-form');
        const budgetAmountField = document.getElementById('budget-amount');
        const budgetCancelBtn = document.getElementById('budget-cancel-btn');
        const budgetDisplayEl = document.getElementById('budget-display');
        const budgetProgressBar = document.getElementById('budget-progress-bar');
        const budgetRemainingTextEl = document.getElementById('budget-remaining-text');

        // Delete Modal
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalBackdrop = document.getElementById('delete-modal-backdrop');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        
        // Search & Export
        const searchBar = document.getElementById('search-bar');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        
        // Insights
        const insightTopCategory = document.getElementById('insight-top-category');
        const insightHighestExpense = document.getElementById('insight-highest-expense');
        const insightAvgSpend = document.getElementById('insight-avg-spend');
        
        // Chart
        const chartToggleBarBtn = document.getElementById('chart-toggle-bar');
        const chartTogglePieBtn = document.getElementById('chart-toggle-pie');
        const barChartContainer = document.getElementById('bar-chart-container');
        const pieChartContainer = document.getElementById('pie-chart-container');
        const pieChartEl = document.getElementById('pie-chart');
        const pieChartLegendEl = document.getElementById('pie-chart-legend');
        
        // Categories
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const categoryModal = document.getElementById('category-modal');
        const categoryModalBackdrop = document.getElementById('category-modal-backdrop');
        const categoryCloseBtn = document.getElementById('category-close-btn');
        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name-input');
        const categoryListEl = document.getElementById('category-list');

        // --- HELPER FUNCTIONS ---
        
        const formatCurrency = (amount) => new Intl.NumberFormat('fr-MA', { style: 'currency', currency: 'MAD' }).format(amount);
        const formatDate = (dateString) => new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getTodayString = () => new Date().toISOString().split('T')[0];

        // --- LOCAL STORAGE FUNCTIONS ---
        const getFromStorage = (key) => {
            const data = localStorage.getItem(key);
            try { return data ? JSON.parse(data) : null; } catch (e) { console.error(`Error parsing ${key}`, e); return null; }
        };
        const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));

        // --- DATA FUNCTIONS ---
        const getExpensesForPeriod = (year, month) => {
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date + 'T00:00:00');
                return expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
            });
        };
        
        const getCategoryTotals = (expenseList) => {
            const totals = Object.keys(categories).reduce((acc, key) => {
                acc[key] = { total: 0, label: categories[key].label, count: 0 };
                return acc;
            }, {});
            
            // Add a safety net for expenses with orphaned categories
            totals['other'] = totals['other'] || { total: 0, label: 'Other', count: 0 };

            let grandTotal = 0;

            expenseList.forEach(expense => {
                const category = expense.category;
                if (totals[category]) {
                    totals[category].total += parseFloat(expense.amount);
                    totals[category].count += 1;
                } else {
                    // If category was deleted, assign to 'other'
                    totals['other'].total += parseFloat(expense.amount);
                    totals['other'].count += 1;
                }
                grandTotal += parseFloat(expense.amount);
            });
            return { totals, grandTotal };
        };

        // --- RENDER FUNCTIONS (THE BIG ONES) ---
        
        /** Main render function, triggers all sub-renders */
        const render = () => {
            const periodExpenses = getExpensesForPeriod(currentYear, currentMonth);
            
            renderExpenseList(periodExpenses);
            renderSummary(periodExpenses);
            renderChart(periodExpenses);
            renderInsights(periodExpenses);
        };

        /** Renders the summary (total + budget) */
        const renderSummary = (periodExpenses) => {
            const total = periodExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            totalExpensesEl.textContent = formatCurrency(total);
            
            if (currentBudget > 0) {
                budgetDisplayEl.textContent = formatCurrency(currentBudget);
                const percentage = Math.min((total / currentBudget) * 100, 100);
                budgetProgressBar.style.width = `${percentage}%`;
                
                // Change color based on percentage
                if (percentage > 90) budgetProgressBar.className = 'bg-red-600 h-2.5 rounded-full';
                else if (percentage > 70) budgetProgressBar.className = 'bg-yellow-500 h-2.5 rounded-full';
                else budgetProgressBar.className = 'bg-blue-600 h-2.5 rounded-full';
                
                const remaining = currentBudget - total;
                budgetRemainingTextEl.textContent = remaining >= 0 ? `${formatCurrency(remaining)} remaining` : `${formatCurrency(Math.abs(remaining))} over budget`;
            } else {
                budgetDisplayEl.textContent = 'Not Set';
                budgetProgressBar.style.width = '0%';
                budgetRemainingTextEl.textContent = 'Set a budget to track spending.';
            }
        };
        
        /** Renders the chart (Bar or Pie) */
        const renderChart = (periodExpenses) => {
            if (chartType === 'bar') {
                barChartContainer.classList.remove('hidden');
                pieChartContainer.classList.add('hidden');
                renderBarChart(periodExpenses);
            } else {
                barChartContainer.classList.add('hidden');
                pieChartContainer.classList.remove('hidden');
                renderPieChart(periodExpenses);
            }
        };
        
        /** Renders the bar chart */
        const renderBarChart = (periodExpenses) => {
            barChartContainer.innerHTML = '';
            const { totals } = getCategoryTotals(periodExpenses);
            const categoryKeys = Object.keys(categories);
            
            let maxTotal = Math.max(...categoryKeys.map(key => totals[key].total));
            if (maxTotal === 0) maxTotal = 1; // Avoid division by zero

            categoryKeys.forEach(key => {
                const total = totals[key].total;
                const heightPercentage = (total / maxTotal) * 100;
                
                const barEl = document.createElement('div');
                barEl.className = "flex flex-col items-center justify-end w-full h-full";
                barEl.innerHTML = `
                    <div class="chart-bar w-1/2 md:w-3/5 bg-blue-600 rounded-t-md" style="height: ${heightPercentage}%" title="${categories[key].label}: ${formatCurrency(total)}"></div>
                    <span class="text-xs text-tertiary mt-2">${categories[key].label}</span>
                `;
                barChartContainer.appendChild(barEl);
            });
        };
        
        /** Renders the pie chart */
        const renderPieChart = (periodExpenses) => {
            const { totals, grandTotal } = getCategoryTotals(periodExpenses);
            if (grandTotal === 0) {
                pieChartEl.style.background = 'var(--bg-tertiary)';
                pieChartLegendEl.innerHTML = '<span class="text-tertiary">No data</span>';
                return;
            }

            const pieColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#F9C851', '#E67E22', '#3498DB', '#2ECC71'];
            let gradientString = 'conic-gradient(';
            let currentAngle = 0;
            let legendHTML = '';
            
            let colorIndex = 0;
            Object.keys(totals).forEach(key => {
                const { total, label } = totals[key];
                if (total > 0) {
                    const percentage = (total / grandTotal) * 100;
                    const angle = (percentage / 100) * 360;
                    const color = pieColors[colorIndex % pieColors.length];
                    
                    gradientString += `${color} ${currentAngle}deg ${currentAngle + angle}deg, `;
                    legendHTML += `
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                            <span class="text-secondary">${label} (${percentage.toFixed(0)}%)</span>
                        </div>
                    `;
                    
                    currentAngle += angle;
                    colorIndex++;
                }
            });
            
            gradientString = gradientString.slice(0, -2) + ')'; // Remove last comma and space
            pieChartEl.style.background = gradientString;
            pieChartLegendEl.innerHTML = legendHTML;
        };

        /** Renders the list of expenses */
        const renderExpenseList = (periodExpenses) => {
            expenseListEl.innerHTML = '';
            
            const filteredExpenses = periodExpenses
                .filter(exp => currentFilter === 'all' || exp.category === currentFilter)
                .filter(exp => currentSearchTerm === '' || exp.title.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            emptyStateEl.classList.toggle('hidden', filteredExpenses.length > 0);

            filteredExpenses.forEach(expense => {
                const item = document.createElement('div');
                item.className = 'glass-card flex items-center justify-between p-4 transition-all duration-200 hover:border-primary/20';
                
                const category = categories[expense.category];
                const categoryIcon = category ? category.icon : GENERIC_ICON;
                
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-tertiary/60 rounded-xl text-primary">
                            ${categoryIcon}
                        </div>
                        <div>
                            <p class="font-semibold text-primary">${expense.title}</p>
                            <p class="text-sm text-tertiary">${formatDate(expense.date)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="font-semibold text-primary text-lg">
                            ${formatCurrency(expense.amount)}
                        </p>
                        <div class="flex gap-2">
                            <button class="edit-btn p-2 text-tertiary hover:text-blue-400 transition-colors" data-id="${expense.id}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button class="delete-btn p-2 text-tertiary hover:text-red-400 transition-colors" data-id="${expense.id}" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                expenseListEl.appendChild(item);
            });
        };
        
        /** Renders the insights card */
        const renderInsights = (periodExpenses) => {
            if (periodExpenses.length === 0) {
                insightTopCategory.innerHTML = `<h3 class="text-sm font-medium text-tertiary">TOP CATEGORY</h3><p class="text-xl font-semibold text-primary">--</p>`;
                insightHighestExpense.innerHTML = `<h3 class="text-sm font-medium text-tertiary">HIGHEST EXPENSE</h3><p class="text-xl font-semibold text-primary">0.00 MAD</p><p class="text-sm text-tertiary truncate">--</p>`;
                insightAvgSpend.innerHTML = `<h3 class="text-sm font-medium text-tertiary">AVG. DAILY SPEND</h3><p class="text-xl font-semibold text-primary">0.00 MAD</p>`;
                return;
            }

            // Top Category
            const { totals } = getCategoryTotals(periodExpenses);
            const topCategory = Object.keys(totals).reduce((a, b) => totals[a].total > totals[b].total ? a : b);
            insightTopCategory.innerHTML = `
                <h3 class="text-sm font-medium text-tertiary">TOP CATEGORY</h3>
                <p class="text-xl font-semibold text-primary">${totals[topCategory].total > 0 ? categories[topCategory].label : '--'}</p>
            `;
            
            // Highest Expense
            const highest = periodExpenses.reduce((max, exp) => parseFloat(exp.amount) > max.amount ? exp : max, { amount: 0 });
            insightHighestExpense.innerHTML = `
                <h3 class="text-sm font-medium text-tertiary">HIGHEST EXPENSE</h3>
                <p class="text-xl font-semibold text-primary">${formatCurrency(highest.amount)}</p>
                <p class="text-sm text-tertiary truncate">${highest.title}</p>
            `;
            
            // Average Daily Spend
            const total = periodExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            const daysInUse = new Set(periodExpenses.map(exp => exp.date)).size;
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const daysSoFar = (currentYear === new Date().getFullYear() && currentMonth === new Date().getMonth()) ? new Date().getDate() : daysInMonth;
            const avg = total / daysSoFar;
            insightAvgSpend.innerHTML = `
                <h3 class="text-sm font-medium text-tertiary">AVG. DAILY SPEND</h3>
                <p class="text-xl font-semibold text-primary">${formatCurrency(avg)}</p>
            `;
        };
        
        // --- MODAL & FORM HANDLING ---

        const openModal = (expense = null) => {
            expenseForm.reset();
            if (expense) {
                modalTitle.textContent = 'Edit Expense';
                expenseIdField.value = expense.id;
                expenseTitleField.value = expense.title;
                expenseAmountField.value = expense.amount;
                expenseCategoryField.value = expense.category;
                expenseDateField.value = expense.date;
                expenseRecurringCheckbox.checked = false;
                expenseRecurringCheckbox.disabled = true;
            } else {
                modalTitle.textContent = 'Add New Expense';
                expenseIdField.value = '';
                expenseDateField.value = getTodayString();
                expenseRecurringCheckbox.checked = false;
                expenseRecurringCheckbox.disabled = false;
            }
            modal.classList.remove('hidden');
        };
        const closeModal = () => modal.classList.add('hidden');

        const handleSubmit = (e) => {
            e.preventDefault();
            
            const id = expenseIdField.value;
            const isRecurring = expenseRecurringCheckbox.checked;

            const expenseData = {
                id: id ? id : new Date().getTime().toString(),
                title: expenseTitleField.value,
                amount: parseFloat(expenseAmountField.value),
                category: expenseCategoryField.value,
                date: expenseDateField.value,
            };

            if (id) {
                // Update
                expenses = expenses.map(exp => exp.id === id ? expenseData : exp);
            } else if (isRecurring) {
                // Add to recurring list
                expenseData.nextDueDate = expenseData.date; // Set first due date
                recurringExpenses.push(expenseData);
                saveToStorage(KEYS.RECURRING, recurringExpenses);
            } else {
                // Add to main list
                expenses.push(expenseData);
            }
            
            saveToStorage(KEYS.EXPENSES, expenses);
            render();
            closeModal();
        };
        
        const handleListClick = (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            
            if (editBtn) {
                openModal(expenses.find(exp => exp.id === editBtn.dataset.id));
            }
            if (deleteBtn) {
                expenseToDeleteId = deleteBtn.dataset.id;
                deleteModal.classList.remove('hidden');
            }
        };
        
        const handleDeleteConfirm = () => {
            if (expenseToDeleteId) {
                expenses = expenses.filter(exp => exp.id !== expenseToDeleteId);
                saveToStorage(KEYS.EXPENSES, expenses);
                render();
                expenseToDeleteId = null;
            }
            deleteModal.classList.add('hidden');
        };

        // --- FEATURE HANDLERS ---
        
        // Theme
        const initTheme = () => {
            const savedTheme = getFromStorage(KEYS.THEME) || 'dark';
            applyTheme(savedTheme);
        };
        const applyTheme = (theme) => {
            if (theme === 'light') {
                docElement.classList.add('light');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
            } else {
                docElement.classList.remove('light');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
            }
            saveToStorage(KEYS.THEME, theme);
        };
        const handleThemeToggle = () => applyTheme(docElement.classList.contains('light') ? 'dark' : 'light');

        // Month Selector
        const populateMonthSelector = () => {
            monthSelector.innerHTML = '';
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                const option = document.createElement('option');
                option.value = `${year}-${month}`;
                option.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                monthSelector.appendChild(option);
            }
            monthSelector.value = `${currentYear}-${currentMonth}`;
        };
        const handleMonthChange = (e) => {
            const [year, month] = e.target.value.split('-').map(Number);
            currentYear = year;
            currentMonth = month;
            render();
        };
        
        // Budget
        const openBudgetModal = () => {
            budgetAmountField.value = currentBudget > 0 ? currentBudget : '';
            budgetModal.classList.remove('hidden');
        };
        const closeBudgetModal = () => budgetModal.classList.add('hidden');
        const handleBudgetSubmit = (e) => {
            e.preventDefault();
            currentBudget = parseFloat(budgetAmountField.value) || 0;
            saveToStorage(KEYS.BUDGET, currentBudget);
            render();
            closeBudgetModal();
        };
        
        // Search & Filter
        const handleFilterChange = (e) => { currentFilter = e.target.value; render(); };
        const handleSearchInput = (e) => { currentSearchTerm = e.target.value; render(); };

        // Chart Toggle
        const handleChartToggle = (type) => {
            chartType = type;
            if (type === 'bar') {
                chartToggleBarBtn.classList.add('bg-blue-600/30', 'text-blue-300');
                chartTogglePieBtn.classList.remove('bg-blue-600/30', 'text-blue-300');
            } else {
                chartTogglePieBtn.classList.add('bg-blue-600/30', 'text-blue-300');
                chartToggleBarBtn.classList.remove('bg-blue-600/30', 'text-blue-300');
            }
            render();
        };

        // Export CSV
        const handleExportCSV = () => {
            const periodExpenses = getExpensesForPeriod(currentYear, currentMonth);
            if (periodExpenses.length === 0) return;
            
            let csv = 'Title,Amount,Category,Date\n';
            periodExpenses.forEach(exp => {
                csv += `"${exp.title}","${exp.amount}","${categories[exp.category].label}","${exp.date}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `expenses_${currentYear}-${currentMonth + 1}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        };
        
        // Recurring Expenses
        const initRecurringExpenses = () => {
            recurringExpenses = getFromStorage(KEYS.RECURRING) || [];
            const today = new Date(getTodayString());
            let expensesAdded = false;
            
            recurringExpenses.forEach(rex => {
                let nextDueDate = new Date(rex.nextDueDate + 'T00:00:00');
                if (nextDueDate <= today) {
                    // Add to main expenses
                    const newExpense = { ...rex, id: new Date().getTime().toString() + rex.id, date: rex.nextDueDate };
                    delete newExpense.nextDueDate;
                    expenses.push(newExpense);
                    
                    // Set next due date (e.g., +1 month)
                    rex.nextDueDate = new Date(nextDueDate.setMonth(nextDueDate.getMonth() + 1)).toISOString().split('T')[0];
                    expensesAdded = true;
                }
            });
            
            if (expensesAdded) {
                saveToStorage(KEYS.EXPENSES, expenses);
                saveToStorage(KEYS.RECURRING, recurringExpenses);
            }
        };
        
        // Category Management
        const initCategories = () => {
            categories = getFromStorage(KEYS.CATEGORIES) || DEFAULT_CATEGORIES;
            saveToStorage(KEYS.CATEGORIES, categories);
            renderCategoryUI();
        };
        const renderCategoryUI = () => {
            // Populate dropdowns
            filterCategoryEl.innerHTML = '<option value="all">All Categories</option>';
            expenseCategoryField.innerHTML = '';
            categoryListEl.innerHTML = '';
            
            Object.keys(categories).forEach(key => {
                const category = categories[key];
                filterCategoryEl.innerHTML += `<option value="${key}">${category.label}</option>`;
                expenseCategoryField.innerHTML += `<option value="${key}">${category.label}</option>`;
                
                // Populate manage modal list
                const isDefault = Object.keys(DEFAULT_CATEGORIES).includes(key);
                categoryListEl.innerHTML += `
                    <div class="flex items-center justify-between p-2 glass-input rounded-lg">
                        <span class="text-primary">${category.label}</span>
                        ${!isDefault ? `<button class="delete-category-btn p-1 text-red-400 hover:text-red-300" data-key="${key}">&times;</button>` : '<span class="text-xs text-tertiary">Default</span>'}
                    </div>
                `;
            });
        };
        const openCategoryModal = () => categoryModal.classList.remove('hidden');
        const closeCategoryModal = () => categoryModal.classList.add('hidden');
        const handleCategorySubmit = (e) => {
            e.preventDefault();
            const name = categoryNameInput.value.trim();
            if (name && !Object.values(categories).find(c => c.label === name)) {
                const key = name.toLowerCase().replace(/\s+/g, '_');
                categories[key] = { label: name, icon: GENERIC_ICON };
                saveToStorage(KEYS.CATEGORIES, categories);
                renderCategoryUI();
                categoryForm.reset();
            }
        };
        const handleCategoryDelete = (e) => {
            const btn = e.target.closest('.delete-category-btn');
            if (btn) {
                const key = btn.dataset.key;
                if (confirm(`Are you sure you want to delete the "${categories[key].label}" category?\nAll expenses in this category will be moved to "Other".`)) {
                    // Re-assign expenses
                    expenses.forEach(exp => {
                        if (exp.category === key) exp.category = 'other';
                    });
                    saveToStorage(KEYS.EXPENSES, expenses);
                    
                    // Delete category
                    delete categories[key];
                    saveToStorage(KEYS.CATEGORIES, categories);
                    
                    renderCategoryUI();
                    render(); // Re-render main app
                }
            }
        };
        
        // --- INITIALIZATION ---
        const init = () => {
            initTheme();
            initCategories();
            expenses = getFromStorage(KEYS.EXPENSES) || [];
            currentBudget = getFromStorage(KEYS.BUDGET) || 0;
            initRecurringExpenses(); // This may modify and save `expenses`
            
            populateMonthSelector();
            render(); // Initial Render
            
            // Event Listeners
            addExpenseBtn.addEventListener('click', () => openModal(null));
            modalBackdrop.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            expenseForm.addEventListener('submit', handleSubmit);
            
            themeToggleBtn.addEventListener('click', handleThemeToggle);
            monthSelector.addEventListener('change', handleMonthChange);
            
            setBudgetBtn.addEventListener('click', openBudgetModal);
            budgetModalBackdrop.addEventListener('click', closeBudgetModal);
            budgetCancelBtn.addEventListener('click', closeBudgetModal);
            budgetForm.addEventListener('submit', handleBudgetSubmit);
            
            deleteModalBackdrop.addEventListener('click', () => deleteModal.classList.add('hidden'));
            deleteCancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
            deleteConfirmBtn.addEventListener('click', handleDeleteConfirm);
            
            filterCategoryEl.addEventListener('change', handleFilterChange);
            searchBar.addEventListener('input', handleSearchInput);
            exportCsvBtn.addEventListener('click', handleExportCSV);
            
            chartToggleBarBtn.addEventListener('click', () => handleChartToggle('bar'));
            chartTogglePieBtn.addEventListener('click', () => handleChartToggle('pie'));
            
            manageCategoriesBtn.addEventListener('click', openCategoryModal);
            categoryModalBackdrop.addEventListener('click', closeCategoryModal);
            categoryCloseBtn.addEventListener('click', closeCategoryModal);
            categoryForm.addEventListener('submit', handleCategorySubmit);
            categoryListEl.addEventListener('click', handleCategoryDelete);
            
            expenseListEl.addEventListener('click', handleListClick);
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>


